import logging
import re
import asyncio
from telegram.ext import Application, MessageHandler, filters
from telegram.constants import ParseMode
from newsendingbot.deduplicator import Deduplicator
from typing import List

# --- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ ---
from newsendingbot.offer_generator import generate_offer_async
from newsendingbot.process_logging import log_news_process


# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
BOT_TOKEN = "*****"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ–º–∞—Ñ–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM
llm_semaphore = asyncio.Semaphore(1)

# -- –î–µ–¥—É–±–ª–∏–∫–∞—Ç–æ—Ä --
deduplicator = Deduplicator(
    threshold=0.85,
    news_file="newsendingbot/queue_for_distribution_recommendations.json"
)

# --- –ü—Ä–æ–º—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
# PROMPT_USER_MAPPING –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ user_id ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π
SYSTEM_PROMPT = """
–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –±–∞–Ω–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º (–ó–ü-–ø—Ä–æ–µ–∫—Ç–∞–º).

–¢–µ–±–µ –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—ë—Ç—Å—è —Ç–µ–∫—Å—Ç –æ–¥–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –¥–∞—ë—Ç –ª–∏ –æ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç.

üî∏ –ö–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å:

–ü–ï–†–í–û–ï –ò –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û:
–ü—Ä–æ–≤–µ—Ä—å, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–æ–≤–æ—Å—Ç–∏ –ö–û–ù–ö–†–ï–¢–ù–û–ï –ù–ê–ó–í–ê–ù–ò–ï –∫–æ–º–ø–∞–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û–û–û –†–æ–º–∞—à–∫–∞", "–∑–∞–≤–æ–¥ '–ó–≤–µ–∑–¥–∞'", "–∫–æ–º–ø–∞–Ω–∏—è '–°—Ç—Ä–æ–π–ú–∞—à'") –∏–ª–∏ –ò–ú–Ø –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ò–ü –ò–≤–∞–Ω–æ–≤", "–±–∏–∑–Ω–µ—Å–º–µ–Ω –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤").
–ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –∏–º–µ–Ω–∏ –ù–ï–¢ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ "–æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π –∑–∞–≤–æ–¥", "–∏–Ω–≤–µ—Å—Ç–æ—Ä –ø–æ—Å—Ç—Ä–æ–∏—Ç —Ü–µ—Ö", "–∫–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∏–ª–∞ —Å—É–±—Å–∏–¥–∏—é" –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è) ‚Äî –°–†–ê–ó–£ –æ—Ç–≤–µ—á–∞–π:
¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.

–í–¢–û–†–û–ï –ü–†–ê–í–ò–õ–û (–õ–ò–ú–ò–¢–´):
–î–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å –º–∞—Å—à—Ç–∞–± —Å–æ–±—ã—Ç–∏—è.
–ï—Å–ª–∏ —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π/—Å—É–±—Å–∏–¥–∏–π/–≥—Ä–∞–Ω—Ç–∞ –ú–ï–ù–¨–®–ï 10 –º–ª–Ω —Ä—É–±–ª–µ–π ‚Äî –°–†–ê–ó–£ –æ—Ç–≤–µ—á–∞–π ¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª.
–ï—Å–ª–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è 3 –∏–ª–∏ –ú–ï–ù–¨–®–ï —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç ‚Äî –°–†–ê–ó–£ –æ—Ç–≤–µ—á–∞–π ¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª.
–ï—Å–ª–∏ —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä –Ω–µ—Ç, –Ω–æ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –º–∞—Å—à—Ç–∞–± –º–µ–ª–∫–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≥—Ä–∞–Ω—Ç –Ω–∞ —à–≤–µ–π–Ω—É—é –º–∞—à–∏–Ω–∫—É", "–æ—Ç–∫—Ä—ã–ª –∫–∏–æ—Å–∫", "–∫—É–ø–∏–ª —Å—Ç–∞–Ω–æ–∫") ‚Äî –°–†–ê–ó–£ –æ—Ç–≤–µ—á–∞–π ¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª.

–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –ï—Å–ª–∏ —Ü–∏—Ñ—Ä –Ω–µ—Ç, –Ω–æ –æ—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –æ–±—ä–µ–∫—Ç –∫—Ä—É–ø–Ω—ã–π (–¢–æ—Ä–≥–æ–≤—ã–π –¶–µ–Ω—Ç—Ä, –ó–∞–≤–æ–¥, –§–∞–±—Ä–∏–∫–∞, –ñ–∏–ª–æ–π –ö–æ–º–ø–ª–µ–∫—Å, –∏ —Ç–¥.) ‚Äî —Ç–æ–≥–¥–∞ –¥–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é.

–¢–†–ï–¢–¨–ï –ü–†–ê–í–ò–õ–û (–°–ú–ï–ù–ê –†–£–ö–û–í–û–î–°–¢–í–ê):
–ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ –≥–æ–≤–æ—Ä–∏—Ç—Å—è –æ —Å–º–µ–Ω–µ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞, —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ –∏–ª–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –≤ –ö–†–£–ü–ù–û–ô –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –Ω–∞ –∑–∞–≤–æ–¥–µ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ –æ –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç–∞—Ö):
–¢–≤–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
¬´–í—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è —Å –Ω–æ–≤—ã–º —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞¬ª

–ß–ï–¢–í–ï–†–¢–û–ï –ü–†–ê–í–ò–õ–û:
–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ (–≤—Å—Ç—Ä–µ—á–∏ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –º–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞), –µ—Å–ª–∏ —Ç–∞–º –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π.

–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–æ–≤–µ—Ä—è–π —Å—É—Ç—å —Å–æ–±—ã—Ç–∏—è:
–ß–∏—Ç–∞–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –∏ –≤—ã–¥–µ–ª—è–π —Å—É—Ç—å —Å–æ–±—ã—Ç–∏—è.
–ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:
–ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–≤–æ–¥–∞, —Ñ–∞–±—Ä–∏–∫–∏, –æ—Ñ–∏—Å–∞, —Ñ–∏–ª–∏–∞–ª–∞, –Ω–∞–π–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∞);
—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–ø—É—Å–∫ –±–∏–∑–Ω–µ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∏–ª–∞ —Å—É–±—Å–∏–¥–∏—é, –æ—Ç–∫—Ä—ã–ª–∞ –Ω–æ–≤–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, –º–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–∞–Ω–∏–º–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤);
–ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∞–ª–æ–≥–æ/—Å—Ä–µ–¥–Ω–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞, —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤, –≥—Ä–∞–Ω—Ç—ã –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π;
–ª—é–±—ã–µ –º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ä–æ—Å—Ç—É —á–∏—Å–ª–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–ª–∏ –ø–æ—è–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–ø–ª–∞—á–∏–≤–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã;

–ò –ø—Ä–∏ —ç—Ç–æ–º –µ—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ —Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –¥–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ —Ä–µ–≥–∏–æ–Ω–æ–≤, –ª–∏–±–æ —Ä–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ:
1. –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π
2. –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π
3. –°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
4. –ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å  
5. –ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å    
6. –ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥
7. –ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π  
8. –ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å

‚Äî –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é, –ø–æ—è—Å–Ω–∏–≤, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤ –Ω–æ–≤–æ—Å—Ç–∏ —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ó–ü-–ø—Ä–æ–µ–∫—Ç–∞.

–ï—Å–ª–∏ —Ä–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–æ —É–ø–æ–º–∏–Ω–∞–π —ç—Ç–æ –≤ —Å–≤–æ—ë–º –æ—Ç–≤–µ—Ç–µ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ:
–¢–µ–∫—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Ç–¥. –í –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ —É–∫–∞–∑–∞–Ω —Ä–µ–≥–∏–æ–Ω, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

–ï—Å–ª–∏ –º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —ç—Ç–æ –∑–∞ —Ä–µ–≥–∏–æ–Ω, –Ω–æ –æ–Ω –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫ –≤—ã—à–µ, —Ç–æ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª



üî∏ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

–ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –∏–ª–∏ —Ç–æ—á–Ω—É—é —Ñ—Ä–∞–∑—É ¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª.
–ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –≤—Å—é –Ω–æ–≤–æ—Å—Ç—å –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π.
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á—ë—Ç–∫–∏–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –±–∞–Ω–∫–∞.

–ü–µ—Ä–µ–¥ —Ç–≤–æ–∏–º –æ—Ç–≤–µ—Ç–æ–º –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞
–ü–æ—Ç–æ–º –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ, –æ —á—ë–º –Ω–æ–≤–æ—Å—Ç—å, –±—É–∫–≤–∞–ª—å–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤
–ê –ø–µ—Ä–µ–¥ —Å–∞–º–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –≤—Å—Ç–∞–≤–ª—è–π <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b>

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å–ª–µ–¥—É—é—â–∞—è:

–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞
–û—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ –æ —á—ë–º –Ω–æ–≤–æ—Å—Ç—å\n
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b>\n
–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ—Ç –Ω–∏—á–µ–≥–æ, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –ø–æ—è–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –±–∏–∑–Ω–µ—Å–∞ –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ó–ü-–ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—â–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∫–µ, –ø–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤, –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ —Ç. –ø.)
–∏–ª–∏
–ï—Å–ª–∏ –ø–æ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–µ–Ω–µ–µ —Ç—Ä—ë—Ö —á–µ–ª–æ–≤–µ–∫
–∏–ª–∏
–ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ª—å–≥–æ—Ç—ã –∏–ª–∏ –±–æ–Ω—É—Å—ã –¥–ª—è –°–ê–ú–û–ó–ê–ù–Ø–¢–´–•
–∏–ª–∏
–ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç–∏ —Ä–µ—á—å –∏–¥—ë—Ç –æ –±–æ–Ω—É—Å–∞—Ö/–ª—å–≥–æ—Ç–∞—Ö/—Å—É–±—Å–∏–¥–∏—è—Ö –¥–ª—è —Å–µ–ª—å—Å–∫–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞ (–≤ —Å–ª—É—á–∞–µ —Å–µ–ª—å—Å–∫–æ–≥–æ —Ö–æ–∑—è—Å—Ç–≤–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
–∏–ª–∏
—Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –¥–µ–π—Å–≤—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ –≤ —Ä–µ–≥–∏–æ–Ω–µ –∏–∑ —É–∫–∞–∑–Ω–Ω–æ–≥–æ –≤—ã—à–µ —Å–ø–∏—Å–∫–∞, –æ—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ —Ñ—Ä–∞–∑–æ–π:
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞
¬´–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π¬ª


–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã:

–ü—Ä–∏–º–µ—Ä 1 (–ï–°–¢–¨ –Ω–∞–∑–≤–∞–Ω–∏–µ, –ö–†–£–ü–ù–´–ô –ø—Ä–æ–µ–∫—Ç):
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ 1
–ö–æ–º–ø–∞–Ω–∏—è "–ê–π—Å–±–µ—Ä–≥" –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—É—é –ª–∏–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –≤ –•–∞–±–∞—Ä–æ–≤—Å–∫–µ, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ 50 –º–ª–Ω —Ä—É–±.\n 
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> 
–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ "–ê–π—Å–±–µ—Ä–≥" –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

–ü—Ä–∏–º–µ—Ä 2 (–ù–ï–¢ –Ω–∞–∑–≤–∞–Ω–∏—è - –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨):
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ 2
–í –ü—Ä–∏–º–æ—Ä—å–µ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ä—ã–±–æ–ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π –∑–∞–≤–æ–¥, —Å–æ–∑–¥–∞–Ω–æ 50 —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç.\n 
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> 
–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

–ü—Ä–∏–º–µ—Ä 3 (–ï–°–¢–¨ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ –ú–ê–õ–û —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç - –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨):
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ 3
–ò–ü –ü–µ—Ç—Ä–æ–≤ –æ—Ç–∫—Ä—ã–ª —Ç–æ—á–∫—É –∫–æ—Ñ–µ —Å —Å–æ–±–æ–π, –Ω–∞–Ω—è–ª 2 –±–∞—Ä–∏—Å—Ç–∞.\n
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b>
–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

–ü—Ä–∏–º–µ—Ä 4 (–ï–°–¢–¨ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ –ú–ê–õ–ï–ù–¨–ö–ê–Ø —Å—É–º–º–∞ - –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨):
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ 4
–§–µ—Ä–º–µ—Ä –ò–≤–∞–Ω–æ–≤ –ø–æ–ª—É—á–∏–ª –≥—Ä–∞–Ω—Ç 3 –º–ª–Ω —Ä—É–±–ª–µ–π –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç—Ä–∞–∫—Ç–æ—Ä–∞.\n
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b>
–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

–ü—Ä–∏–º–µ—Ä 5 (–ï–°–¢–¨ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–µ—Ç —Ü–∏—Ñ—Ä, –Ω–æ –ö–†–£–ü–ù–´–ô –æ–±—ä–µ–∫—Ç):
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ 5
–ó–∞–≤–æ–¥ "–ú–µ—Ç–∞–ª–ª–°—Ç—Ä–æ–π" –Ω–∞—á–∞–ª —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–æ–≤–æ–≥–æ —Ü–µ—Ö–∞.\n 
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> 
–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–≤–æ–¥—É "–ú–µ—Ç–∞–ª–ª–°—Ç—Ä–æ–π" –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –í –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ —É–∫–∞–∑–∞–Ω —Ä–µ–≥–∏–æ–Ω, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
    """

# –ö–∞–Ω–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ)
CHANNELS = {
    '@businessnews27',
    '@RGSNIK27',
}

# --- –ú–∞–ø–ø–∏–Ω–≥ —Ä–µ–≥–∏–æ–Ω -> —Å–ø–∏—Å–æ–∫ user_id (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ user_id) ---
# –ü—Ä–∏–º–µ—Ä:
# –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (idA)
# –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B (idB)
# –°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C (idC) 

REGION_USERS = {
    "–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π": [869062649, 142740976, 1690362656, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 525857948, 1693539003, 1808652783, 346200023, 260491741, 268190621, 153615309],  # –ú–æ–π –ø–µ—Ä–≤—ã–π –∞–∫–∫
    "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π": [869062649, 168684648, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 7427156552, 491447536, 525857948, 346200023, 260491741, 268190621, 153615309],    # –ú–æ–π –≤—Ç–æ—Ä–æ–π –∞–∫–∫
    "–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": [869062649, 583918100, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 492731295, 567395729, 525857948, 346200023, 260491741, 268190621, 153615309], # –°–∞–Ω—è
    "–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å": [869062649, 1372589698, 298168795, 400089282, 315868671, 461691764, 6780357523, 1516932503, 182718136, 245425461, 196044264, 789580905, 626067454, 525857948, 346200023, 260491741, 268190621, 153615309],  # –ú–∏—à–∞
    "–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": [869062649, 1276691978, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 318818959, 1061716113, 525857948, 346200023, 260491741, 268190621, 153615309, 40008982],  # –ì–æ—à–∞
    "–ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥": [869062649, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 710274863, 5684384494, 525857948, 346200023, 260491741, 268190621, 153615309], # –ü–æ–ª–∏–Ω–∞
    "–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π": [869062649, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 829024142, 525857948, 346200023, 260491741, 268190621, 153615309],
    "–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": [869062649, 238277391, 298168795, 400089282, 315868671, 461691764, 1516932503, 182718136, 245425461, 196044264, 1330740881, 525857948, 346200023, 260491741, 268190621, 153615309],
}

# –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–≥–∏–æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å "–≤—Å–µ–º", —Ç–æ –Ω–∏–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–æ–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö user_id –∏–∑ REGION_USERS

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

processed_messages = set()

# --- –°–ø–∏—Å–æ–∫ "–¥—Ä—É–≥–∏—Ö" —Ä–µ–≥–∏–æ–Ω–æ–≤ ---
OTHER_REGIONS_LIST = [
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è", "–ú–∞–π–∫–æ–ø",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω", "–£—Ñ–∞",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë—É—Ä—è—Ç–∏—è", "–£–ª–∞–Ω-–£–¥—ç",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π", "–ì–æ—Ä–Ω–æ-–ê–ª—Ç–∞–π—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω", "–ú–∞—Ö–∞—á–∫–∞–ª–∞",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è", "–ú–∞–≥–∞—Å",
    "–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–ù–∞–ª—å—á–∏–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è", "–≠–ª–∏—Å—Ç–∞",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è", "–ß–µ—Ä–∫–µ—Å—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è", "–ü–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏", "–°—ã–∫—Ç—ã–≤–∫–∞—Ä",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–∞—Ä–∏–π –≠–ª", "–ô–æ—à–∫–∞—Ä-–û–ª–∞",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–æ—Ä–¥–æ–≤–∏—è", "–°–∞—Ä–∞–Ω—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)", "–Ø–∫—É—Ç—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è-–ê–ª–∞–Ω–∏—è", "–í–ª–∞–¥–∏–∫–∞–≤–∫–∞–∑",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω", "–ö–∞–∑–∞–Ω—å",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢—ã–≤–∞", "–ö—ã–∑—ã–ª",
    "–£–¥–º—É—Ä—Ç—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–ò–∂–µ–≤—Å–∫",
    "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –•–∞–∫–∞—Å–∏—è", "–ê–±–∞–∫–∞–Ω",
    "–ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–ì—Ä–æ–∑–Ω—ã–π",
    "–ß—É–≤–∞—à—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–ß–µ–±–æ–∫—Å–∞—Ä—ã",
    "–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π", "–ë–∞—Ä–Ω–∞—É–ª",
    "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π", "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä",
    "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫",
    "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π", "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å",
    "–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫",
    "–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å",
    "–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ë–µ–ª–≥–æ—Ä–æ–¥",
    "–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ë—Ä—è–Ω—Å–∫",
    "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–ª–∞–¥–∏–º–∏—Ä",
    "–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–æ–ª–≥–æ–≥—Ä–∞–¥",
    "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–æ–ª–æ–≥–¥–∞",
    "–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–æ—Ä–æ–Ω–µ–∂",
    "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ò–≤–∞–Ω–æ–≤–æ",
    "–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ò—Ä–∫—É—Ç—Å–∫",
    "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥",
    "–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–∞–ª—É–≥–∞",
    "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–µ–º–µ—Ä–æ–≤–æ",
    "–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–∏—Ä–æ–≤",
    "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–æ—Å—Ç—Ä–æ–º–∞",
    "–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö—É—Ä–≥–∞–Ω",
    "–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö—É—Ä—Å–∫",
    "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
    "–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–õ–∏–ø–µ—Ü–∫",
    "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ú–æ—Å–∫–≤–∞",
    "–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ú—É—Ä–º–∞–Ω—Å–∫",
    "–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
    "–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
    "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
    "–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û–º—Å–∫",
    "–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û—Ä–µ–Ω–±—É—Ä–≥",
    "–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û—Ä–µ–ª",
    "–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ü–µ–Ω–∑–∞",
    "–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π", "–ü–µ—Ä–º—å",
    "–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ü—Å–∫–æ–≤",
    "–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
    "–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–†—è–∑–∞–Ω—å",
    "–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–∞–º–∞—Ä–∞",
    "–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–∞—Ä–∞—Ç–æ–≤",
    "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
    "–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–º–æ–ª–µ–Ω—Å–∫",
    "–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢–∞–º–±–æ–≤",
    "–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢–≤–µ—Ä—å",
    "–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢–æ–º—Å–∫",
    "–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢—É–ª–∞",
    "–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢—é–º–µ–Ω—å",
    "–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–£–ª—å—è–Ω–æ–≤—Å–∫",
    "–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ß–µ–ª—è–±–∏–Ω—Å–∫",
    "–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π", "–ß–∏—Ç–∞",
    "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–Ø—Ä–æ—Å–ª–∞–≤–ª—å",
    "–≥. –ú–æ—Å–∫–≤–∞", "–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
    "–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥", "–ù–∞—Ä—å—è–Ω-–ú–∞—Ä",
    "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ - –Æ–≥—Ä–∞", "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫",
    "–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥", "–°–∞–ª–µ—Ö–∞—Ä–¥"
]


def build_flexible_other_regions_pattern(regions_list):
    """
    –°—Ç—Ä–æ–∏—Ç –≥–∏–±–∫–∏–π regex-–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤, –≤–∫–ª—é—á–∞—è –ø–∞–¥–µ–∂–Ω—ã–µ —Ñ–æ—Ä–º—ã.
    """
    roots = set()

    for name in regions_list:
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º
        n = name.lower().strip()
        n = re.sub(r"\b(—Ä–µ—Å–ø\.?|—Ä–µ—Å–ø—É–±–ª–∏–∫–∞|–æ–±–ª\.?|–æ–±–ª–∞—Å—Ç—å|–∫—Ä–∞–π|–∞–æ|–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π|–≥\.?|–≥–æ—Ä–æ–¥)\b", "", n)
        n = re.sub(r"[^–∞-—è—ë\- ]", " ", n)  # –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É, –¥–µ—Ñ–∏—Å –∏ –ø—Ä–æ–±–µ–ª
        n = n.strip()
        if not n:
            continue

        # –ë–µ—Ä–µ–º –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∏ –µ–≥–æ "–∫–æ—Ä–µ–Ω—å"
        for part in n.split():
            if len(part) > 4:
                roots.add(re.escape(part[:6]))  # –ø–µ—Ä–≤—ã–µ 6 –±—É–∫–≤
            else:
                roots.add(re.escape(part))

    # –û–¥–∏–Ω –±–æ–ª—å—à–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω ‚Äî –∏—â–µ–º –ª—é–±–æ–µ —Å–ª–æ–≤–æ, –Ω–∞—á–∏–Ω–∞—é—â–µ–µ—Å—è —Å –∫–æ—Ä–Ω—è, –¥–æ 5 –¥–æ–ø. –±—É–∫–≤
    alternation = "|".join(sorted(roots, key=lambda x: -len(x)))
    pattern = rf"\b(?:{alternation})[–∞-—è—ë\-]{{0,5}}\b"
    return re.compile(pattern, flags=re.IGNORECASE)

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –æ–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
OTHER_REGIONS_PATTERN = build_flexible_other_regions_pattern(OTHER_REGIONS_LIST)

def detect_other_regions(text: str):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö "–¥—Ä—É–≥–∏—Ö" —Ä–µ–≥–∏–æ–Ω–æ–≤ (–≥–∏–±–∫–æ ‚Äî –ª–æ–≤–∏—Ç –ø–∞–¥–µ–∂–∏, —Ñ–æ—Ä–º—ã, –æ–∫–æ–Ω—á–∞–Ω–∏—è).
    """
    if not text:
        return []
    found = set()
    for m in OTHER_REGIONS_PATTERN.finditer(text):
        found.add(m.group(0))
    return list(found)

# --- –£–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤ ---
def detect_regions(text: str) -> List[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫—Ä—ã–≤–∞—é—â–∏–µ –ø–∞–¥–µ–∂–Ω—ã–µ —Ñ–æ—Ä–º—ã,
    —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –∫–ª—é—á–µ–≤—ã–µ –≥–æ—Ä–æ–¥–∞.
    """
    if not text:
        return []

    regions_found = set()
    t = text.lower()

    # –°–ª–æ–≤–∞—Ä—å region_name -> –æ–¥–∏–Ω –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (raw string)
    patterns = {
        "–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π": r"""
            \b(?:                                      # –•–∞–±–∞—Ä–æ–≤—Å–∫ / –∫—Ä–∞–π
                —Ö–∞–±–∞—Ä–æ–≤—Å–∫(?:\w{0,7})                   # —Ö–∞–±–∞—Ä–æ–≤—Å–∫, —Ö–∞–±–∞—Ä–æ–≤—Å–∫–∞, —Ö–∞–±–∞—Ä–æ–≤—Å–∫–µ...
                |
                —Ö–∞–±–∞—Ä–æ–≤—Å–∫(?:\w{0,7})?\s*–∫—Ä–∞(?:\w{0,4}) # —Ö–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π (+–≤–∞—Ä–∏–∞—Ü–∏–∏)
                |
                –∫–æ–º—Å–æ–º–æ–ª—å—Å–∫(?:\w{0,7})?[-\s]?–Ω–∞[-\s]?–∞–º—É—Ä–µ         # –∫–æ–º—Å–æ–º–æ–ª—å—Å–∫-–Ω–∞-–∞–º—É—Ä–µ
                |
                –Ω–∏–∫–æ–ª–∞–µ–≤—Å–∫(?:\w{0,7})?[-\s]?–Ω–∞[-\s]?–∞–º—É—Ä–µ
                |
                —Å–æ–≤–µ—Ç—Å–∫(?:\w{0,7})\s–≥–∞–≤–∞–Ω(?:\w{0,7})                       # —Å–æ–≤–µ—Ç—Å–∫–∞—è –≥–∞–≤–∞–Ω—å
            )\b
        """,

        "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π": r"""
            \b(?:
                –ø—Ä–∏–º–æ—Ä—Å–∫(?:–∏–π|\w{0,7})?               # –ø—Ä–∏–º–æ—Ä—Å–∫–∏–π, –ø—Ä–∏–º–æ—Ä—Å–∫–æ–≥–æ –∏ —Ç.–ø.
                |
                –ø—Ä–∏–º–æ—Ä—å(?:–µ|\w{0,7})?               # –ø—Ä–∏–º–æ—Ä—Å–∫–∏–π, –ø—Ä–∏–º–æ—Ä—Å–∫–æ–≥–æ –∏ —Ç.–ø.
                |
                –≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫(?:\w{0,7})                # –≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫–µ...
                |
                —É—Å—Å—É—Ä–∏–π—Å–∫(?:\w{0,7})                  # —É—Å—Å—É—Ä–∏–π—Å–∫
                |
                –Ω–∞—Ö–æ–¥–∫(?:\w{0,7})?                      # –Ω–∞—Ö–æ–¥–∫–∞/–Ω–∞—Ö–æ–¥–∫–µ
                |
                –∞—Ä—Å–µ–Ω—å–µ–≤(?:\w{0,7})
                |
                –∞—Ä—Ç–µ–º(?:\w{0,7})
                |
                –ª–µ—Å–æ–∑–∞–≤–æ–¥—Å–∫(?:\w{0,7})
            )\b
        """,

        "–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": r"""
            \b(?:
                —Å–∞—Ö–∞–ª–∏–Ω(?:\w{0,7})                    # —Å–∞—Ö–∞–ª–∏–Ω, —Å–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –∏ —Ç.–ø.
                |
                —é–∂–Ω–æ[-\s]?—Å–∞—Ö–∞–ª–∏–Ω—Å–∫(?:\w{0,7})         # —é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫
                |
                –∫–æ—Ä—Å–∞–∫–æ–≤(?:\w{0,7})
                |
                —Ö–æ–ª–º—Å–∫(?:\w{0,7})
                |
                –æ—Å—Ç—Ä–æ–≤(?:–∞\s+–∫—É—Ä–∏–ª—å—Å–∫(?:–∏–µ|–∏—Ö))?       # –∫—É—Ä–∏–ª—å—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            )\b
        """,

        "–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å": r"""
            \b(?:
                –µ–≤—Ä–µ(?:–π—Å–∫(?:\w{0,7})?\s+–∞–≤—Ç–æ–Ω–æ–º–Ω(?:\w{0,7})?(?:\s+–æ–±–ª–∞—Å—Ç—å|)|–µ–≤—Ä–µ–π—Å–∫–∞—è\s+–∞–æ)
                |
                –±–∏—Ä–æ–±–∏–¥–∂–∞–Ω(?:\w{0,7})
                |
                –æ–±–ª—É—á—å–µ(?:\w{0,7})
                |
                E–ê–û
            )\b
        """,

        "–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": r"""
            \b(?:
                –∞–º—É—Ä—Å–∫(?:–∞—è|–æ–π|—É—é|–æ–º|\w{0,5})?         # –∞–º—É—Ä—Å–∫–∞—è/–∞–º—É—Ä—Å–∫–æ–π –∏ —Ç.–¥.
                |
                –±–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫(?:\w{0,7})
                |
                —Å–≤–æ–±–æ–¥–Ω—ã–π(?:\w{0,7})
                |
                —Ç—ã–Ω–¥–∞(?:\w{0,7})
                |
                –∑–µ—è(?:\w{0,7})
                |
                —à–∏–º–∞–Ω–æ–≤—Å–∫(?:\w{0,7})
            )\b
        """,

        "–ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥": r"""
            \b(?:
                —á—É–∫–æ—Ç—Å–∫(?:\w{0,7})?             # —á—É–∫–æ—Ç—Å–∫–∏–π/—á—É–∫–æ—Ç–∫–∏ –∏ —Ç.–ø.
                |
                —á—É–∫–æ—Ç–∫–∞(?:\w{0,7})
                |
                –∞–Ω–∞–¥—ã—Ä(?:—å|–µ|—è)?
                |
                –ø–µ–≤–µ–∫(?:\w{0,7})
                |
                –±–µ—Ä–∏–Ω–≥–æ–≤—Å–∫(?:\w{0,7})
            )\b
        """,

        "–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π": r"""
            \b(?:
                –∫–∞–º—á–∞—Ç—Å–∫(?:\w{0,7})?            # –∫–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π
                |
                –ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫[-\s]?–∫–∞–º—á–∞—Ç—Å–∫(?:\w{0,7})? # –ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–∫–∞–º—á–∞—Ç—Å–∫–∏–π (—Ä–∞–∑–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è)
                |
                –µ–ª–∏–∑–æ–≤–æ(?:\w{0,7})
                |
                –º–∞–≥–∞–¥–∞–Ω—Å–∫(?:\w{0,7})?                     # –∑–∞—â–∏—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –º–∞–≥–∞–¥–∞–Ω—Å–∫ (–ø–æ–∫—Ä—ã—Ç–∏–µ —Å–º–µ—à–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º)
            )\b
        """,

        "–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": r"""
            \b(?:
                –º–∞–≥–∞–¥–∞–Ω(?:\w{0,7})
                |
                –º–∞–≥–∞–¥–∞–Ω—Å–∫(?:\w{0,7})?
                |
                —Å–µ—è—Ö–∞(?:\w{0,7})                        # —Ä–µ–¥–∫–∏–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å/–¥–æ–ø–æ–ª–Ω–∏—Ç—å
            )\b
        """
    }

    # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å —Ñ–ª–∞–≥–æ–º IGNORECASE –∏ VERBOSE (–¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏)
    for region, pat in patterns.items():
        try:
            regex = re.compile(pat, flags=re.IGNORECASE | re.VERBOSE)
        except re.error:
            # –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –≤ –ø–∞—Ç—Ç–µ—Ä–Ω–µ ‚Äî –±—ã—Å—Ç—Ä–æ fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏–º–µ–Ω–∏ —Ä–µ–≥–∏–æ–Ω–∞
            if region.lower().split()[0] in t:
                regions_found.add(region)
            continue

        if regex.search(t):
            regions_found.add(region)

    return list(regions_found)


async def handle_channel_post(update, context):
    try:
        post = update.channel_post
        if not post:
            return

        channel_username = post.chat.username
        channel_key = f"@{channel_username}" if channel_username else None

        # –ï—Å–ª–∏ —Ö–æ—Ç–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞–Ω–∞–ª–∞–º ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º
        if channel_key and channel_key not in CHANNELS:
            return

        message_key = f"{channel_key}_{post.message_id}"
        if message_key in processed_messages:
            return
        processed_messages.add(message_key)

        # --- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ ---
        if post.text or post.caption:
            original_text = post.text or post.caption

            # --- –†–∞–∑–±–∏–≤–∞–µ–º –ø–∞—á–∫—É –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ ---
            news_blocks = [
                block.strip()
                for block in original_text.split("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
                if block.strip()
            ]  

            # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º: user_id -> list[str]
            recommendations_by_user = {}

            for news in news_blocks:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω(—ã) –Ω–æ–≤–æ—Å—Ç–∏ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
                regions = detect_regions(news) 

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º "–ø—Ä–æ—á–∏–µ" —Ä–µ–≥–∏–æ–Ω—ã –∏–∑ –±–æ–ª—å—à–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
                # –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç ‚Äî –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ other_regions = []
                other_regions = []
                try:
                    other_regions = detect_other_regions(news)
                except NameError:
                    other_regions = []

                # –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
                # 1) –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤, –Ω–æ –µ—Å—Ç—å "–ø—Ä–æ—á–∏–µ" —Ä–µ–≥–∏–æ–Ω—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ—Å—Ç—å (–Ω–∏–∫–æ–º—É –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
                if not regions and other_regions:
                    logger.info(f"–ù–æ–≤–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—á–∏–µ —Ä–µ–≥–∏–æ–Ω—ã {other_regions} ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∏–∫–æ–º—É).")
                    continue

                # 2) –ï—Å–ª–∏ –µ—Å—Ç—å —Ü–µ–ª–µ–≤—ã–µ —Ä–µ–≥–∏–æ–Ω—ã ‚Äî —Å–æ–±–∏—Ä–∞–µ–º user_id –¥–ª—è —ç—Ç–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
                if regions:
                    target_user_ids = set()
                    for r in regions:
                        ulist = REGION_USERS.get(r, [])
                        for uid in ulist:
                            target_user_ids.add(uid)
                else:
                    # 3) –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Ü–µ–ª–µ–≤—ã—Ö, –Ω–∏ –ø—Ä–æ—á–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ ‚Äî —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∏–∑ REGION_USERS
                    target_user_ids = set(uid for ulist in REGION_USERS.values() for uid in ulist)

                actual_recipients = []
                final_proposal = None

                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ target user
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ target user
                
                async def process_user_task(uid):
                    try:
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è)
                        if deduplicator.is_duplicate(news, user_id=uid):
                            logger.info(f"–î—É–±–ª–∏–∫–∞—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {uid}, –Ω–æ–≤–æ—Å—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–∞")
                            return None
                        
                        deduplicator.add(news, user_id=uid)

                        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ LLM —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ —Å–µ–º–∞—Ñ–æ—Ä
                        async with llm_semaphore:
                            offer = await generate_offer_async(news, SYSTEM_PROMPT)
                            # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –ü–û–°–õ–ï –∑–∞–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã —Å–æ–±–ª—é—Å—Ç–∏ RPS
                            await asyncio.sleep(1.5)
                            return (uid, offer)
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ task –¥–ª—è user {uid}: {e}")
                        return None

                # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –≤—Å–µ—Ö —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                tasks = [process_user_task(uid) for uid in target_user_ids]
                
                # –ñ–¥–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–æ —Å —É—á–µ—Ç–æ–º —Å–µ–º–∞—Ñ–æ—Ä–∞)
                results = await asyncio.gather(*tasks)

                for res in results:
                    if not res:
                        continue
                    uid, processed_text = res
                    
                    if not processed_text:
                        continue

                    if "–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π" not in processed_text:
                        recommendations_by_user.setdefault(uid, []).append(processed_text)
                        
                        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–ª—è –ª–æ–≥–∞ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
                        final_proposal = processed_text
                        actual_recipients.append(uid)

                # –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –±—ã–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏
                if actual_recipients and final_proposal:
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ —Å—Ç—Ä–æ–∫—É
                    region_str = ", ".join(regions) if regions else "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω"
                    
                    # –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    try:
                        log_news_process(news, final_proposal, region_str, actual_recipients)
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")

            # –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            for user_id, recs in recommendations_by_user.items():
                for rec in recs:
                    try:
                        await context.bot.send_message(
                            chat_id=user_id,
                            text=rec,
                            parse_mode=ParseMode.HTML
                        )
                        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    except Exception as e:
                        logger.exception(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

        else:
            # –µ—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            all_user_ids = set(uid for ulist in REGION_USERS.values() for uid in ulist)
            news_url = getattr(post, "text", "") or getattr(post, "caption", "")
            
            # –ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å —Å—Å—ã–ª–∫—É –∏–∑ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
            match = re.search(r"https?://\S+", news_url)
            url = match.group(0) if match else f"{post.chat.username}/{post.message_id}"
            
            fallback_text = f"–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ LLM, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å: {url}"

            for user_id in all_user_ids:
                try:
                    await context.bot.send_message(
                        chat_id=user_id,
                        text=fallback_text,
                        parse_mode=ParseMode.HTML
                    )
                except Exception as e:
                    logger.exception(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ channel_post")
def main():
    application = Application.builder().token(BOT_TOKEN).build()

    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ—Å—Ç—ã –≤ –∫–∞–Ω–∞–ª–∞—Ö
    application.add_handler(MessageHandler(filters.ChatType.CHANNEL, handle_channel_post))

    logger.info("–ë–æ—Ç —Å LLM –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥—ë—Ç –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤...")
    application.run_polling()

if __name__ == "__main__":
    main()
